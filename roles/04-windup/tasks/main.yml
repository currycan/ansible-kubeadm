- block:
  # Error from server: Get "https://10.0.1.4:10250/containerLogs/kube-system/kube-apiserver-10.0.1.4/kube-apiserver?follow=true": remote error: tls: internal error
  - name: 手动 approve csr
    shell: >
      [ `kubectl get csr | grep 'Pending' | wc -l` -ne 0 ] && \
      kubectl get csr | grep Pending | awk '{print $1}' | xargs -L 1 kubectl certificate approve|| exit 0
    environment:
        KUBECONFIG: "{{ kubernetes_etc_dir }}/admin.conf"
    args:
      executable: /bin/bash
    run_once: true
    delegate_to: "{{ groups['kube_masters'] | difference(groups['delete_masters']) | unique | first }}"

  - block:
    - name: 创建 endpoint 配置清单目录
      file:
        name: "{{ kubernetes_etc_dir }}/endpoint"
        state: directory
        mode: 0664

    - name: 配置核心组件的 endpoint 清单文件, 以便用于prometheus监控
      template:
        src: "endpoint/{{ item }}.j2"
        dest: "{{ kubernetes_etc_dir }}/endpoint/{{ item }}"
        mode: 0664
      with_items:
        - control-plane-ep.yml
        - data-plane-ep.yml
    when: inventory_hostname in (groups['kube_masters'] | difference(groups['delete_masters']))

  - name: 创建核心组件的 endpoint
    shell: >
      kubectl apply -f {{ kubernetes_etc_dir }}/endpoint/
    environment:
      KUBECONFIG: "{{ kubernetes_etc_dir }}/admin.conf"
    register: apply_endpoint
    until: apply_endpoint.rc == 0
    retries: 3
    delay: "{{ retry_stagger }}"
    run_once: true
    delegate_to: "{{ groups['kube_masters'] | difference(groups['delete_masters']) | unique | first }}"
  when: inventory_hostname in (groups['kube_cluster'] | difference(groups['delete_masters']) | difference(groups['delete_nodes']) | unique)
