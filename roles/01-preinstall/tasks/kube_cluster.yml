- name: 二进制安装 kubernetes
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: 0755
  with_items:
    - { src: "{{ cache_dir }}/binary/kubernetes/", dest: "/usr/bin/"}

- name: 添加 kubectl kubeadm 命令自动补全
  lineinfile:
    dest: "{{ ansible_env.HOME }}/.bashrc"
    state: present
    regexp: "{{ item }} completion"
    line: "source <({{ item }} completion bash)"
  with_items:
    - kubectl
    - kubeadm

- name: kubectl kubeadm 自动补全写入 /etc/bash_completion.d/
  shell: >
    {{ item }} completion bash > /etc/bash_completion.d/{{ item }};
    source {{ ansible_env.HOME }}/.bash_profile
  args:
    executable: /bin/bash
  with_items:
    - kubectl
    - kubeadm

- name: 安装 kubelet 启动优化脚本
  copy:
    src: "kubelet-pre-start.sh"
    dest: "/usr/local/bin/"
    owner: root
    group: root
    mode: 0755

- name: 添加 kube-apiserver 域名到 hosts 文件中
  blockinfile:
    path: /etc/hosts
    block: |-
      {% for domain in kube_master_external_domain.split(',') %}
      {{ lb_apiserver_ip }} {{ domain | trim }}
      {% endfor %}
    mode: 0644
    state: present
    create: yes
    backup: yes
    marker: "# Ansible kube-apiserver domain {mark}"
